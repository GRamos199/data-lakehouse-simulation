name: Terraform Plan & Apply

on:
  push:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
    branches: [ main, develop ]
  pull_request:
    paths:
      - 'terraform/**'
    branches: [ main, develop ]

env:
  TF_VERSION: 1.5.0
  AWS_REGION: us-east-1

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init
      
      - name: Wait for LocalStack to be ready
        run: |
          for i in {1..60}; do
            if curl -s http://localhost:4566/_localstack/health | grep -q '"services"'; then
              echo "✓ LocalStack is ready"
              exit 0
            fi
            echo "Waiting for LocalStack... ($i/60)"
            sleep 2
          done
          echo "✗ LocalStack failed to start"
          exit 1
      
      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate
      
      - name: Terraform Plan (LocalStack)
        run: |
          cd terraform
          terraform plan -var="use_localstack=true" -var="environment=local" -out=tfplan
      
      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
      
      - name: Post plan as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planPath = 'terraform/tfplan';
            
            if (fs.existsSync(planPath)) {
              const plan = fs.readFileSync(planPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Terraform Plan\n\`\`\`\n${plan}\n\`\`\``
              });
            }

  terraform-apply:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init
      
      - name: Terraform Apply (LocalStack)
        run: |
          cd terraform
          terraform apply -auto-approve \
            -var="use_localstack=true" \
            -var="environment=local"
      
      - name: Export outputs
        run: |
          cd terraform
          terraform output -json > outputs.json
          cat outputs.json
      
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/outputs.json

  localstack-health:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Start LocalStack
        run: |
          docker run -d \
            -p 4566:4566 \
            -e SERVICES=s3,dynamodb,sns,sqs,cloudwatch,logs,events \
            localstack/localstack:latest
      
      - name: Wait for LocalStack
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:4566/_localstack/health; then
              echo "LocalStack is healthy"
              exit 0
            fi
            echo "Waiting for LocalStack... ($i/30)"
            sleep 1
          done
          echo "LocalStack failed to start"
          exit 1
      
      - name: Verify S3 bucket creation
        run: |
          aws s3 ls --endpoint-url http://localhost:4566 || true
      
      - name: Verify DynamoDB table creation
        run: |
          aws dynamodb list-tables \
            --endpoint-url http://localhost:4566 \
            --region us-east-1 || true
